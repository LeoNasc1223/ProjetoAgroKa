{% extends "base.html" %}

{% block title %}Análise de Vendas e Estoque{% endblock %}

{% block head %}
{% endblock %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-header bg-dark">
        <h2 class="h4 mb-0">Análise de Vendas e Estoque</h2>
        <p class="mb-0 text-muted">Calcula os dias de estoque restante para cada produto com base nas vendas dos últimos <strong>{{ sales_period_days }} dias</strong>.</p>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <input type="text" id="analysisSearch" class="form-control" placeholder="Filtrar por produto ou código...">
        </div>

        {% if analysis_results %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th scope="col">Código</th>
                        <th scope="col">Produto</th>
                        <th scope="col" class="text-center">Estoque Atual</th>
                        <th scope="col" class="text-center">Dias de Estoque Restante</th>
                    </tr>
                </thead>
                <tbody id="analysisTableBody">
                    {% for product in analysis_results %}
                    <tr>
                        <td><a href="{{ url_for('product_detail', codigo_produto=product.codigo_produto) }}">{{ product.codigo_produto }}</a></td>
                        <td>{{ product.nome_produto }}</td>
                        <td class="text-center">{{ product.estoque_sistema }}</td>
                        <td class="text-center">
                            {% set dias = product.dias_de_estoque %}
                            {% if dias == "N/A" %}
                                <span class="badge bg-secondary">{{ dias }}</span>
                            {% elif dias == "Infinito" %}
                                <span class="badge bg-info text-dark">{{ dias }}</span>
                            {% else %}
                                {% set dias_num = dias|int %}
                                {% if dias_num <= 7 %}
                                    <span class="badge bg-danger">{{ dias_num }} dias</span>
                                {% elif dias_num <= 30 %}
                                    <span class="badge bg-warning text-dark">{{ dias_num }} dias</span>
                                {% else %}
                                    <span class="badge bg-success">{{ dias_num }} dias</span>
                                {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info text-center" role="alert">
            <i class="fas fa-info-circle me-2"></i>Nenhum dado de produto ou venda disponível para análise.
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('analysisSearch').addEventListener('keyup', function() {
    let filter = this.value.toUpperCase();
    let tableBody = document.getElementById('analysisTableBody');
    let rows = tableBody.getElementsByTagName('tr');

    for (let i = 0; i < rows.length; i++) {
        let cells = rows[i].getElementsByTagName('td');
        let found = false;
        if (cells.length > 0) {
            // Busca no código (célula 0) e nome (célula 1)
            if ((cells[0] && cells[0].textContent.toUpperCase().indexOf(filter) > -1) ||
                (cells[1] && cells[1].textContent.toUpperCase().indexOf(filter) > -1)) {
                found = true;
            }
            
            if (found) {
                rows[i].style.display = "";
            } else {
                rows[i].style.display = "none";
            }
        }
    }
});
</script>
{% endblock %}
