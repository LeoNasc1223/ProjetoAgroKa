{% extends "base.html" %}
{% block title %}Relatório de Validade{% endblock %}

{% block head %}
<style>
    .card {
        animation: fadeIn 0.6s ease-in-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    /* Garante que o hover funcione mesmo em linhas com cor de fundo */
    .table-hover tbody tr:hover {
        background-color: rgba(0,0,0,.075) !important;
    }
    .btn-action {
        margin-right: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-header bg-dark">
        <h2 class="h4 mb-0">Relatório de Validade</h2>
        <p class="mb-0 text-muted">Monitore produtos com data de validade próxima ou vencidos.</p>
    </div>
    <div class="card-body">
        <div class="p-3 mb-4 rounded" style="background-color: var(--bs-tertiary-bg);">
            <div class="row g-3 align-items-center">
                <div class="col-md-5">
                    <form method="GET" action="{{ url_for('expiry_report') }}" class="d-flex align-items-end gap-2">
                        <div class="flex-grow-1">
                            <label for="days" class="form-label">Mostrar produtos vencendo nos próximos:</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="days" name="days" value="{{ threshold }}" min="1">
                                <span class="input-group-text">dias</span>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Filtrar</button>
                    </form>
                </div>
                <div class="col-md-7">
                    <label for="lotSearch" class="form-label">Buscar na lista atual:</label>
                    <input type="text" id="lotSearch" class="form-control" placeholder="Filtrar por produto, código ou lote...">
                </div>
            </div>
        </div>

        {% if lots %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th scope="col">Produto</th>
                        <th scope="col">Código</th>
                        <th scope="col">Lote</th>
                        <th scope="col" class="text-center">Qtd. em Estoque</th>
                        <th scope="col" class="text-center">Data de Validade</th>
                        <th scope="col" class="text-center">Status</th>
                        <th scope="col" class="text-center">Ações</th>
                    </tr>
                </thead>
                <tbody id="lotTableBody">
                    {% for lot in lots %}
                    <tr class="{{ 'table-danger' if lot.dias_restantes <= 0 else 'table-warning' if lot.dias_restantes <= 15 }}">
                        <td>{{ lot.nome_produto }}</td>
                        <td>{{ lot.codigo_produto }}</td>
                        <td>{{ lot.numero_lote or 'N/A' }}</td>
                        <td class="text-center">{{ lot.quantidade }}</td>
                        <td class="text-center">{{ macros.format_date(lot.data_validade) }}</td>
                        <td class="text-center">
                            {% if lot.dias_restantes <= 0 %}<span class="badge bg-danger">Vencido há {{ lot.dias_restantes|abs }} dia(s)</span>{% else %}<span class="badge bg-warning text-dark">Vence em {{ lot.dias_restantes }} dia(s)</span>{% endif %}
                        </td>
                        <td class="text-center">
                            <a href="{{ url_for('edit_lot', lot_id=lot.id) }}" class="btn btn-sm btn-warning btn-action" title="Editar Lote"><i class="fas fa-edit"></i></a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-success" role="alert">
            <i class="fas fa-check-circle me-2"></i>Nenhum produto encontrado com data de validade no período selecionado.
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('lotSearch').addEventListener('keyup', function() {
    let filter = this.value.toUpperCase();
    let tableBody = document.getElementById('lotTableBody');
    let rows = tableBody.getElementsByTagName('tr');

    for (let i = 0; i < rows.length; i++) {
        let cells = rows[i].getElementsByTagName('td');
        let found = false;
        if (cells.length > 0) {
            // Itera sobre as células de dados, ignorando a última (Ações)
            for (let j = 0; j < cells.length - 1; j++) {
                if (cells[j] && cells[j].textContent.toUpperCase().indexOf(filter) > -1) {
                    found = true;
                    break;
                }
            }
            if (found) {
                rows[i].style.display = "";
            } else {
                rows[i].style.display = "none";
            }
        }
    }
});
</script>
{% endblock %}