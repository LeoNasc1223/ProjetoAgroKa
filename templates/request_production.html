{% extends "base.html" %}

{% block title %}Solicitar Produção{% endblock %}

{% block head %} {{ super() }}
<style>
    /* Estilo para o spinner de carregamento */
    .loader {
        border: 4px solid #f3f3f3;
        border-radius: 50%;
        border-top: 4px solid #3498db;
        width: 20px;
        height: 20px;
        -webkit-animation: spin 2s linear infinite; /* Safari */
        animation: spin 2s linear infinite;
        display: none; /* Começa escondido */
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Estilo para o container de autocomplete, igual ao da página principal */
    .autocomplete-container {
        max-height: 200px;
        overflow-y: auto;
        overflow-x: hidden;
        /* z-index é aplicado inline para garantir a sobreposição correta */
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header">
            <h3><i class="fas fa-cogs me-2"></i>Solicitar Produção de Item Fracionado</h3>
        </div>
        <div class="card-body">
            <p class="card-text">Use este formulário para solicitar a quebra de um produto maior (saco) em pacotes menores para venda.</p>
            
            <form id="productionForm" method="POST" action="{{ url_for('request_production') }}">
                <div class="row">
                    <!-- Coluna do Produto Fracionado (Menor) -->
                    <div class="col-lg-6 mb-4">
                        <h5>1. Produto a ser Criado (Pacote Menor)</h5>
                        <div class="card p-3">
                            <div class="form-group position-relative">
                                <label for="busca_produto_fracionado"><strong>Buscar Produto</strong></label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="busca_produto_fracionado" placeholder="Digite nome, código ou EAN..." required>
                                    <button class="btn btn-outline-secondary" type="button" id="clear_btn_fracionado" style="display: none;"><i class="fas fa-times"></i></button>
                                </div>
                                <div id="autocomplete_container_fracionado" class="list-group position-absolute w-100 autocomplete-container" style="z-index: 1051;"></div>
                            </div>
                            <input type="hidden" id="codigo_produto_fracionado" name="codigo_produto_fracionado">
                            <input type="hidden" id="nome_produto_fracionado" name="nome_produto_fracionado">
                        </div>
                        <div class="mt-3">
                            <label for="qtd_prateleira" class="form-label">Quantidade Atual na Prateleira:</label>
                            <input type="number" id="qtd_prateleira" name="qtd_prateleira" class="form-control" placeholder="Ex: 5" required min="0" disabled>
                        </div>
                    </div>

                    <!-- Coluna do Produto de Origem (Maior) -->
                    <div class="col-lg-6 mb-4">
                        <h5>2. Produto de Origem (Saco a ser Aberto)</h5>
                        <div class="card p-3">
                            <div class="form-group position-relative">
                                <label for="busca_produto_origem"><strong>Buscar Produto</strong></label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="busca_produto_origem" placeholder="Digite nome, código ou EAN..." required>
                                    <button class="btn btn-outline-secondary" type="button" id="clear_btn_origem" style="display: none;"><i class="fas fa-times"></i></button>
                                </div>
                                <div id="autocomplete_container_origem" class="list-group position-absolute w-100 autocomplete-container" style="z-index: 1051;"></div>
                            </div>
                            <input type="hidden" id="codigo_produto_origem" name="codigo_produto_origem">
                            <input type="hidden" id="nome_produto_origem" name="nome_produto_origem">
                        </div>
                    </div>
                </div>

                <!-- Seção de Resultados e Ação -->
                <hr>
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5>3. Resultado do Cálculo</h5>
                        <div id="calculationResult" class="alert alert-secondary">
                            Selecione os dois produtos para calcular.
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="d-flex align-items-center justify-content-end">
                            <div id="calculationLoader" class="loader me-3"></div>
                            <button type="submit" id="submitButton" class="btn btn-primary btn-lg" disabled>
                                <i class="fas fa-paper-plane me-2"></i>Enviar Solicitação
                            </button>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="quantidade_calculada" name="quantidade_calculada">
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- LÓGICA DE DEMONSTRAÇÃO PADRÃO ---
    const demoModal = new bootstrap.Modal(document.getElementById('demoModal'));
    const demoModalBody = document.getElementById('demoModalBody');
    const demoModalFooter = document.getElementById('demoModalFooter');
    const demoModalLabel = document.getElementById('demoModalLabel');
    let currentDemoStep = 0;
    let currentDemoSteps = [];

    function updateDemoModalContent() {
        const step = currentDemoSteps[currentDemoStep];
        demoModalLabel.innerHTML = `<i class="fas fa-cogs me-2"></i> ${step.title}`;
        demoModalBody.innerHTML = step.content;
        let footerHTML = '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>';
        if (currentDemoSteps.length > 1) {
            footerHTML = `<button type="button" class="btn btn-outline-secondary" id="prevBtn" ${currentDemoStep === 0 ? 'disabled' : ''}>Anterior</button>` + footerHTML;
            footerHTML += `<button type="button" class="btn btn-primary" id="nextBtn" ${currentDemoStep === currentDemoSteps.length - 1 ? 'disabled' : ''}>Próximo</button>`;
        }
        demoModalFooter.innerHTML = footerHTML;
    }

    document.getElementById('demoModal').addEventListener('click', function handler(event) {
        if (event.target.id === 'nextBtn' && currentDemoStep < currentDemoSteps.length - 1) {
            currentDemoStep++;
            updateDemoModalContent();
        } else if (event.target.id === 'prevBtn' && currentDemoStep > 0) {
            currentDemoStep--;
            updateDemoModalContent();
        }
    });

    function showDemoModal(steps, startIndex = 0) {
        currentDemoSteps = steps;
        currentDemoStep = startIndex;
        updateDemoModalContent();
        demoModal.show();
    }

    const productionSteps = [
        {
            title: "Passo 1: Seleção e Cálculo",
            content: `
                <p>O operador seleciona dois produtos:</p>
                <ul>
                    <li>O <strong>produto a ser criado</strong> (ex: pacote de 2.5KG).</li>
                    <li>O <strong>produto de origem</strong> (ex: saco de 50KG).</li>
                </ul>
                <p>O sistema automaticamente extrai o peso de cada nome de produto e calcula quantos pacotes menores podem ser produzidos a partir de um saco maior, exibindo o resultado na tela.</p>
                <p class='text-center bg-dark p-2 rounded'><code>Qtd. Produzida = Peso do Saco / Peso do Pacote</code></p>
            `
        },
        {
            title: "Passo 2: Envio da Solicitação",
            content: `
                <p>Ao clicar em "Enviar Solicitação", o sistema não altera o estoque diretamente. Em vez disso, ele cria uma nova tarefa na planilha do Google Sheets, na aba <strong>'PRODUÇÃO'</strong>.</p>
                <p>Esta nova linha na planilha contém todas as informações necessárias:</p>
                <ul>
                    <li>Data e hora da solicitação.</li>
                    <li>Nome do solicitante.</li>
                    <li>Produtos envolvidos (origem e fracionado).</li>
                    <li>Quantidade a ser produzida.</li>
                    <li>Um status inicial de <strong>'PENDENTE'</strong>.</li>
                </ul>
            `
        },
        {
            title: "Passo 3: Fluxo de Trabalho Manual",
            content: `
                <p>A solicitação na planilha serve como um gatilho para um processo manual:</p>
                <ol>
                    <li>A <strong>equipe de produção</strong> visualiza a tarefa pendente na planilha.</li>
                    <li>Eles realizam a quebra do produto fisicamente.</li>
                    <li>Após a produção, um responsável <strong>ajusta manualmente o estoque no sistema E-Trade</strong>, dando baixa no saco grande e entrada nos pacotes menores.</li>
                    <li>Finalmente, o status da tarefa na planilha é alterado para <strong>'CONCLUÍDO'</strong>.</li>
                </ol>
                <p>Este fluxo garante um controle claro sobre as solicitações e a execução da produção, separando a tarefa do sistema da ação física no estoque.</p>
            `
        }
    ];

    // --- LÓGICA EXISTENTE DA PÁGINA ---

    // Função de debounce para evitar chamadas excessivas à API
    function debounce(func, wait) {
        let timeout;
        return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); };
    }

    // Função que dispara o cálculo
    const triggerCalculation = debounce(function() {
        const nomeFracionado = $('#nome_produto_fracionado').val();
        const nomeOrigem = $('#nome_produto_origem').val();
        const resultDiv = $('#calculationResult');
        const submitButton = $('#submitButton'); // Usando jQuery aqui pois já está em uso
        const loader = $('#calculationLoader');

        // Reseta o estado
        resultDiv.html('Selecione os dois produtos para calcular.').removeClass('alert-success alert-danger').addClass('alert-secondary');
        submitButton.prop('disabled', true);
        $('#quantidade_calculada').val('');
        
        if (nomeFracionado && nomeOrigem) {
            loader.show();
            $.ajax({
                url: "{{ url_for('api_calculate_production') }}",
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    nome_fracionado: nomeFracionado,
                    nome_origem: nomeOrigem
                }),
                success: function(data) {
                    if (data.success) {
                        resultDiv.html(`
                            <strong><i class="fas fa-check-circle me-1"></i>Cálculo bem-sucedido!</strong><br>
                            Com um saco de <strong>${data.peso_origem} KG</strong>, será possível produzir <strong>${data.quantidade_calculada}</strong> pacotes de <strong>${data.peso_fracionado} KG</strong>.<br>
                            <small>Sobra estimada: ${data.sobra_kg} KG.</small>
                        `).removeClass('alert-secondary alert-danger').addClass('alert-success');
                        $('#quantidade_calculada').val(data.quantidade_calculada);
                        submitButton.prop('disabled', false);
                    } else {
                        resultDiv.html(`<strong><i class="fas fa-exclamation-triangle me-1"></i>Erro no cálculo:</strong> ${data.error}`)
                                 .removeClass('alert-secondary alert-success').addClass('alert-danger');
                    }
                },
                error: function(jqXHR) {
                    const errorMsg = jqXHR.responseJSON ? jqXHR.responseJSON.error : 'Erro de comunicação com o servidor.';
                    resultDiv.html(`<strong><i class="fas fa-times-circle me-1"></i>Erro:</strong> ${errorMsg}`)
                             .removeClass('alert-secondary alert-success').addClass('alert-danger');
                },
                complete: function() {
                    loader.hide();
                }
            });
        }
    }, 500);

    // Função para configurar a busca de produtos (código e nome)
    function setupUnifiedSearch(type) {
        const searchInput = document.getElementById(`busca_produto_${type}`);
        const autocompleteContainer = document.getElementById(`autocomplete_container_${type}`);
        const clearBtn = document.getElementById(`clear_btn_${type}`);
        const codeHiddenInput = document.getElementById(`codigo_produto_${type}`);
        const nameHiddenInput = document.getElementById(`nome_produto_${type}`);
        const qtdPrateleiraInput = document.getElementById('qtd_prateleira');

        function resetSearch() {
            searchInput.value = '';
            searchInput.disabled = false;
            codeHiddenInput.value = '';
            nameHiddenInput.value = '';
            clearBtn.style.display = 'none';
            autocompleteContainer.innerHTML = '';
            autocompleteContainer.style.display = 'none';
            if (type === 'fracionado') {
                qtdPrateleiraInput.disabled = true;
            }
            triggerCalculation();
            searchInput.focus();
        }

        function selectProduct(product) {
            codeHiddenInput.value = product.codigo;
            nameHiddenInput.value = product.nome;
            searchInput.value = product.label;
            searchInput.disabled = true;
            clearBtn.style.display = 'block';
            autocompleteContainer.innerHTML = '';
            autocompleteContainer.style.display = 'none';
            if (type === 'fracionado') {
                qtdPrateleiraInput.disabled = false;
                qtdPrateleiraInput.focus();
            }
            triggerCalculation();
        }

        searchInput.addEventListener('input', debounce(async function() {
            const query = this.value.trim();
            autocompleteContainer.innerHTML = '';
            autocompleteContainer.style.display = 'none';
            if (query.length < 2) return;

            try {
                const response = await fetch(`{{ url_for('api_product_search') }}?q=${encodeURIComponent(query)}`);
                const products = await response.json();
                if (products.length > 0) {
                    autocompleteContainer.style.display = 'block';
                    products.forEach(product => {
                        const item = document.createElement('a');
                        item.href = '#';
                        item.className = 'list-group-item list-group-item-action';
                        item.innerHTML = `${product.label} <span class="badge bg-secondary float-end">Estoque: ${product.estoque !== null ? product.estoque : 'N/A'}</span>`;
                        item.addEventListener('click', (e) => {
                            e.preventDefault();
                            selectProduct(product);
                        });
                        autocompleteContainer.appendChild(item);
                    });
                }
            } catch (error) {
                console.error(`Erro na busca (${type}):`, error);
            }
        }, 300));

        clearBtn.addEventListener('click', resetSearch);
    }

    // Configura os dois blocos de busca de produto
    setupUnifiedSearch('fracionado');
    setupUnifiedSearch('origem');

    // Fecha os autocompletes se clicar fora
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.form-group')) {
            document.getElementById('autocomplete_container_fracionado').style.display = 'none';
            document.getElementById('autocomplete_container_origem').style.display = 'none';
        }
    });

    // Validação do formulário antes do envio
    $('#productionForm').on('submit', function(e) {
        e.preventDefault(); // Impede o envio real do formulário

        if ($('#submitButton').is(':disabled')) {
            alert('Por favor, preencha todos os campos e certifique-se de que o cálculo foi realizado com sucesso antes de enviar.');
            return;
        }

        // Se a validação passar, mostra o modal de demonstração
        showDemoModal(productionSteps);
    });
});
</script>
{% endblock %}
