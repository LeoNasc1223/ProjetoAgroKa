{% extends "base.html" %}

{% block title %}Configurações do Sistema{% endblock %}

{% block head %}
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-dark d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="h4 mb-0">Configurações do Sistema</h2>
                    <p class="mb-0 text-muted">Ajuste os parâmetros globais do sistema.</p>
                </div>
                <a href="#" id="settingsHelp" title="Como funciona esta página?">
                    <i class="fas fa-question-circle fa-2x text-info"></i>
                </a>
            </div>
            <div class="card-body">
                <form id="settingsForm" method="POST" action="{{ url_for('system_settings') }}">
                    <div class="mb-3">
                        <label for="sales_analysis_period_days" class="form-label">Período de Análise de Vendas (dias)</label>
                        <input type="number" class="form-control" id="sales_analysis_period_days" name="sales_analysis_period_days" value="{{ settings.SALES_ANALYSIS_PERIOD_DAYS }}" min="1" required>
                        <div class="form-text">Define o período (em dias) para calcular a velocidade de vendas e os dias de estoque restante.</div>
                    </div>

                    <hr class="my-4">
                    
                    <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i>Salvar Configurações</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- LÓGICA DE DEMONSTRAÇÃO PADRÃO ---
    const demoModal = new bootstrap.Modal(document.getElementById('demoModal'));
    const demoModalBody = document.getElementById('demoModalBody');
    const demoModalFooter = document.getElementById('demoModalFooter');
    const demoModalLabel = document.getElementById('demoModalLabel');

    let currentDemoStep = 0;
    let currentDemoSteps = [];

    function updateDemoModalContent() {
        const step = currentDemoSteps[currentDemoStep];
        demoModalLabel.innerHTML = `<i class="fas fa-cog me-2"></i> ${step.title}`;
        demoModalBody.innerHTML = step.content;

        let footerHTML = '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>';
        if (currentDemoSteps.length > 1) {
            footerHTML = `<button type="button" class="btn btn-outline-secondary" id="prevBtn" ${currentDemoStep === 0 ? 'disabled' : ''}>Anterior</button>` + footerHTML;
            footerHTML += `<button type="button" class="btn btn-primary" id="nextBtn" ${currentDemoStep === currentDemoSteps.length - 1 ? 'disabled' : ''}>Próximo</button>`;
        }
        demoModalFooter.innerHTML = footerHTML;
    }

    document.getElementById('demoModal').addEventListener('click', function handler(event) {
        if (event.target.id === 'nextBtn' && currentDemoStep < currentDemoSteps.length - 1) {
            currentDemoStep++;
            updateDemoModalContent();
        } else if (event.target.id === 'prevBtn' && currentDemoStep > 0) {
            currentDemoStep--;
            updateDemoModalContent();
        }
    });

    function showDemoModal(steps, startIndex = 0) {
        currentDemoSteps = steps;
        currentDemoStep = startIndex;
        updateDemoModalContent();
        demoModal.show();
    }

    const pageExplanation = [
        {
            title: "O que são as Configurações do Sistema?",
            content: `
                <p>Esta página permite que administradores ajustem parâmetros que afetam o comportamento de todo o sistema.</p>
                <p>Alterar esses valores pode mudar a forma como os relatórios são calculados e como as análises são apresentadas.</p>
                <h5>Período de Análise de Vendas</h5>
                <p>Este é um dos parâmetros mais importantes. Ele define a "janela de tempo" que o sistema usa para calcular a média de vendas de um produto. Atualmente, afeta diretamente o relatório de <strong>Análise de Vendas</strong>, que calcula os "Dias de Estoque Restante".</p>
                <p class='text-center bg-dark p-2 rounded'>Um período menor (ex: 7 dias) torna a análise mais sensível a picos de venda recentes, enquanto um período maior (ex: 90 dias) oferece uma visão mais estável e sazonal.</p>
            `
        }
    ];

    // --- Conexão dos Gatilhos com o Modal ---
    const helpIcon = document.getElementById('settingsHelp');
    if (helpIcon) {
        helpIcon.addEventListener('click', function(event) {
            event.preventDefault();
            showDemoModal(pageExplanation);
        });
    }

    const settingsForm = document.getElementById('settingsForm');
    if (settingsForm) {
        settingsForm.addEventListener('submit', function(event) {
            event.preventDefault(); // Impede o envio real do formulário
            const period = document.getElementById('sales_analysis_period_days').value;
            const simulationSteps = [{
                title: "Simulando Alteração",
                content: `<p>Em um ambiente real, o sistema salvaria o valor <strong>${period} dias</strong> no banco de dados. A partir de agora, todos os relatórios que dependem deste parâmetro usariam o novo valor para seus cálculos.</p><p>Como este é um modo de demonstração, nenhuma alteração será salva.</p>`
            }];
            showDemoModal(simulationSteps);
        });
    }
});
</script>
{% endblock %}
