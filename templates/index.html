{% extends "base.html" %}

{% block title %}AgroKa System{% endblock %}

{% block head %}
    <style>
        .card {
            animation: fadeIn 0.6s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .info-box {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            margin-top: 0.5rem;
            border-radius: .375rem;
            font-size: 0.9em;
            background-color: var(--bs-tertiary-bg);
            border: 1px solid var(--bs-border-color-translucent);
            transition: all 0.3s ease;
        }
        .info-box.error {
            background-color: var(--bs-danger-bg-subtle);
            border-color: var(--bs-danger-border-subtle);
            color: var(--bs-danger-text-emphasis);
        }
        .viewport {
            position: relative;
            width: 100%;
            height: auto;
            overflow: hidden;
            border-radius: .375rem;
        }
        .viewport video, .viewport canvas {
            width: 100%;
            height: auto;
        }
        .viewport canvas.drawingBuffer {
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
{% endblock %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h1 class="h4 mb-0">Entrada de Dados da Prateleira</h1>
        <div class="text-end">
            <a href="{{ url_for('review_sales') }}" class="btn btn-sm btn-outline-secondary position-relative me-2">
                <i class="fas fa-clipboard-check me-1"></i>Revisar Vendas
                {% if pending_sales_count > 0 %}
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                        {{ pending_sales_count }}
                        <span class="visually-hidden">vendas para revisar</span>
                    </span>
                {% endif %}
            </a>
             {% if session.get('cargo') == 'Admin' %}
                <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-outline-secondary"><i class="fas fa-chart-line me-1"></i>Dashboard</a>
                <a href="{{ url_for('admin_logs_entradas') }}" class="btn btn-sm btn-outline-secondary"><i class="fas fa-history me-1"></i>Logs</a>
            {% endif %}
        </div>
    </div>
    <div class="card-body">

        <div class="text-center my-4">
            <button type="button" id="btnScanBarcode" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#barcodeScannerModal">
                <i class="fas fa-barcode me-2"></i> Ler Código de Barras
            </button>
        </div>
<!-- NOVO FORMULÁRIO DE ENTRADA DE PRODUTOS -->
<form method="POST" action="{{ url_for('index') }}" id="entradaForm" autocomplete="off">
    <!-- 1. Campo de Busca Unificado -->
    <div class="form-group position-relative">
        <label for="busca_produto_unificada"><strong>Buscar Produto</strong></label>
        <div class="input-group">
            <input type="text" class="form-control form-control-lg" id="busca_produto_unificada" placeholder="Digite para buscar..." autofocus>
            <div class="input-group-append">
                <button class="btn btn-secondary" type="button" id="clearSearchBtn" style="display: none;">
                    <i class="fas fa-times"></i> Limpar
                </button>
            </div>
        </div>
        <!-- Container para os resultados do autocomplete -->
        <div id="autocomplete-container" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
    </div>

    <hr>

    <!-- 2. Campos de Detalhes e Entrada (Sempre visíveis, mas desabilitados) -->
    <input type="hidden" id="codigo_produto" name="codigo_produto">
    
    <div class="form-row">
        <div class="form-group col-md-8">
            <label for="nome_produto">Nome do Produto</label>
            <input type="text" class="form-control" id="nome_produto" name="nome_produto" readonly required placeholder="Selecione um produto na busca acima...">
        </div>
        <div class="form-group col-md-4">
            <label>Estoque Atual do Sistema</label>
            <input type="hidden" id="estoque_sistema" name="estoque_sistema">
            <div id="system_stock_info_display" class="info-box" style="display: none; padding-top: 0.5rem; padding-bottom: 0.5rem;"></div>
        </div>
    </div>

    <!-- 3. Campos para entrada do usuário (habilitados após seleção) -->
    <div class="form-row">
        <div class="form-group col-md-6">
            <label for="qtd_prateleira">Quantidade na Prateleira</label>
            <input type="number" class="form-control" id="qtd_prateleira" name="qtd_prateleira" required disabled>
            <div id="backstock_info_display" class="info-box" style="display: none;"></div>
        </div>
        <div class="form-group col-md-6">
            <label for="qtd_para_abastecer">Quantidade para Abastecer</label>
            <input type="number" class="form-control" id="qtd_para_abastecer" name="qtd_para_abastecer" required disabled>
        </div>
    </div>

    <!-- 4. Opção de Forçar Compra -->
    <div class="form-group">
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="forcar_compra" name="forcar_compra" disabled>
            <label class="form-check-label" for="forcar_compra">
                Sugerir compra mesmo com estoque no depósito
            </label>
            <i class="fas fa-question-circle demo-info-icon" 
               data-title="Forçar Pedido de Compra"
               data-explanation="Esta opção força o sistema a adicionar o produto na planilha de 'COMPRAS', mesmo que o cálculo do 'backstock' (estoque de depósito) indique que ainda há unidades disponíveis. É útil para produtos de alta rotatividade ou em promoção, garantindo que um novo pedido seja feito com antecedência para evitar rupturas."></i>
        </div>
    </div>

    <!-- NOVO: Botão para marcar inversão PET/Loja 1 -->
    <div class="form-group">
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="marcar_invertido" name="marcar_invertido" disabled>
            <label class="form-check-label" for="marcar_invertido">
                Marcar produto na planilha contrária
            </label>
            <i class="fas fa-question-circle demo-info-icon"
               data-title="Planilha Contrária"
               data-explanation="O sistema é configurado para duas lojas (Loja 1 - AGRO e Loja 2 - PET). Normalmente, um produto pertence a uma das lojas. Marcar esta opção faz com que a solicitação de reposição seja enviada para a planilha da outra loja. Por exemplo, se um produto de PET precisa ser reposto na loja AGRO, esta opção garante que a solicitação apareça na planilha correta para a equipe responsável."></i>
        </div>
    </div>

    <button type="submit" id="submitBtn" class="btn btn-primary btn-lg btn-block" disabled>Registrar Entrada</button>
</form>
<!-- FIM DO NOVO FORMULÁRIO -->

<!-- Modal do Scanner -->
<div class="modal fade" id="barcodeScannerModal" tabindex="-1" aria-labelledby="barcodeScannerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="barcodeScannerModalLabel"><i class="fas fa-barcode me-2"></i>Leitor de Código de Barras</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="scanner-viewport" class="viewport"></div>
        <p class="mt-2 text-center">Status: <span id="scanStatus" class="fw-bold">Aguardando...</span></p>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
    <!-- Biblioteca QuaggaJS para leitura de código de barras -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Elementos do DOM ---
            const searchInput = document.getElementById('busca_produto_unificada');
            const autocompleteContainer = document.getElementById('autocomplete-container');
            const productDetailsContainer = document.getElementById('product-details-container');
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            const entradaForm = document.getElementById('entradaForm');
            
            // Campos do formulário
            const codigoProdutoInput = document.getElementById('codigo_produto');
            const nomeProdutoInput = document.getElementById('nome_produto');
            const estoqueSistemaInput = document.getElementById('estoque_sistema');
            const qtdPrateleiraInput = document.getElementById('qtd_prateleira');
            const qtdParaAbastecerInput = document.getElementById('qtd_para_abastecer');
            const forcarCompraInput = document.getElementById('forcar_compra');
            const backstockInfoDiv = document.getElementById('backstock_info_display');
            const systemStockInfoDiv = document.getElementById('system_stock_info_display');
            const submitBtn = document.getElementById('submitBtn');
            const marcarInvertidoInput = document.getElementById('marcar_invertido');

            // Elementos do Modal de Demonstração
            const demoModal = new bootstrap.Modal(document.getElementById('demoModal'));
            const demoModalBody = document.getElementById('demoModalBody');
            const demoModalFooter = document.getElementById('demoModalFooter');
            const demoModalLabel = document.getElementById('demoModalLabel');

            // --- Funções de Controle do Formulário ---

            function resetForm() {
                entradaForm.reset(); // Limpa todos os campos do formulário
                autocompleteContainer.innerHTML = '';
                autocompleteContainer.style.display = 'none';
                clearSearchBtn.style.display = 'none';
                searchInput.disabled = false;
                searchInput.value = '';
                nomeProdutoInput.placeholder = 'Selecione um produto na busca acima...';

                // Desabilita os campos de entrada
                qtdPrateleiraInput.disabled = true;
                qtdParaAbastecerInput.disabled = true;
                forcarCompraInput.disabled = true;
                marcarInvertidoInput.disabled = true;
                submitBtn.disabled = true;
                backstockInfoDiv.style.display = 'none';
                systemStockInfoDiv.style.display = 'none';

                searchInput.focus();
            }

            function selectProduct(product) {
                // Preenche os campos do formulário com os dados do produto selecionado
                codigoProdutoInput.value = product.codigo;
                nomeProdutoInput.value = product.nome;

                const stockValue = product.estoque !== null ? product.estoque : 0;
                const stockDisplay = product.estoque !== null ? product.estoque : 'N/A';
                estoqueSistemaInput.value = stockValue; // Armazena o valor numérico no campo oculto
                systemStockInfoDiv.innerHTML = `<i class="fas fa-boxes" style="margin-right: 8px;"></i> Estoque Atual do Sistema: <strong>${stockDisplay}</strong>`;
                systemStockInfoDiv.style.display = 'flex';

                searchInput.value = product.nome; // Atualiza o campo de busca para mostrar o nome

                // Ajusta a interface
                searchInput.disabled = true;
                clearSearchBtn.style.display = 'block';
                autocompleteContainer.innerHTML = '';
                autocompleteContainer.style.display = 'none';
                
                // Habilita os campos de entrada
                qtdPrateleiraInput.disabled = false;
                qtdParaAbastecerInput.disabled = false;
                forcarCompraInput.disabled = false;
                marcarInvertidoInput.disabled = false;
                submitBtn.disabled = false;

                // Foca no primeiro campo de entrada do usuário
                qtdPrateleiraInput.focus();
            }

            function calculateBackstock() {
                const systemStockStr = estoqueSistemaInput.value;
                const qtdPrateleiraStr = qtdPrateleiraInput.value;

                // Não mostra se a quantidade na prateleira estiver vazia
                if (qtdPrateleiraStr === '') {
                    backstockInfoDiv.style.display = 'none';
                    return;
                }

                const qtdPrateleira = parseInt(qtdPrateleiraStr, 10);
                const systemStock = parseInt(systemStockStr, 10);

                if (!isNaN(systemStock) && !isNaN(qtdPrateleira) && qtdPrateleira >= 0) {
                    const backstock = systemStock - qtdPrateleira;
                    let message = `<i class="fas fa-warehouse" style="margin-right: 8px;"></i> Estoque de Retaguarda (Backstock): <strong>${backstock}</strong>`;
                    
                    backstockInfoDiv.className = backstock < 0 ? 'info-box error' : 'info-box';
                    if (backstock < 0) message += ` (Atenção: negativo!)`;

                    backstockInfoDiv.innerHTML = message;
                    backstockInfoDiv.style.display = 'flex';
                } else {
                    backstockInfoDiv.style.display = 'none';
                }
            }

            // --- Lógica do Autocomplete ---

            searchInput.addEventListener('input', async function() {
                const query = this.value.trim();
                autocompleteContainer.innerHTML = '';
                autocompleteContainer.style.display = 'none';

                if (query.length < 2) return;

                try {
                    const response = await fetch(`{{ url_for('api_product_search') }}?q=${encodeURIComponent(query)}`);
                    const products = await response.json();

                    if (products.length > 0) {
                        autocompleteContainer.style.display = 'block';
                        products.forEach(product => {
                            const item = document.createElement('a');
                            item.href = '#';
                            item.className = 'list-group-item list-group-item-action';
                            item.innerHTML = `${product.label} <span class="badge bg-secondary float-end">Estoque: ${product.estoque !== null ? product.estoque : 'N/A'}</span>`;
                            item.addEventListener('click', (e) => {
                                e.preventDefault();
                                selectProduct(product);
                            });
                            autocompleteContainer.appendChild(item);
                        });
                    }
                } catch (error) {
                    console.error('Erro na busca por autocompletar:', error);
                }
            });

            // Fecha o autocomplete se clicar fora
            document.addEventListener('click', function(e) {
                if (e.target !== searchInput) {
                    autocompleteContainer.style.display = 'none';
                }
            });

            // Listener para o botão de limpar
            clearSearchBtn.addEventListener('click', resetForm);

            // Listener para calcular o backstock em tempo real
            qtdPrateleiraInput.addEventListener('input', calculateBackstock);

            // --- LÓGICA DE DEMONSTRAÇÃO ---

            const demoSteps = [
                {
                    title: "Passo 1: Coleta e Validação dos Dados",
                    content: `
                        <p>Primeiramente, o sistema coleta todas as informações inseridas no formulário:</p>
                        <ul>
                            <li><strong>Código do Produto:</strong> ${codigoProdutoInput.value || '<em>(não preenchido)</em>'}</li>
                            <li><strong>Nome do Produto:</strong> ${nomeProdutoInput.value || '<em>(não preenchido)</em>'}</li>
                            <li><strong>Qtd. na Prateleira:</strong> ${qtdPrateleiraInput.value || '<em>(não preenchido)</em>'}</li>
                            <li><strong>Qtd. para Abastecer:</strong> ${qtdParaAbastecerInput.value || '<em>(não preenchido)</em>'}</li>
                        </ul>
                        <p>Ele valida se todos os campos obrigatórios foram preenchidos. Em seguida, registra essa entrada em um log interno no banco de dados para fins de auditoria e análise de produtividade do operador.</p>
                    `
                },
                {
                    title: "Passo 2: Cálculo do Backstock e Decisão",
                    content: `
                        <p>O sistema calcula o <strong>Backstock</strong> (estoque de retaguarda/depósito) para decidir a ação a ser tomada.</p>
                        <p class='text-center bg-dar p-2 rounded'><code>Backstock = (Estoque Total no Sistema) - (Qtd. na Prateleira)</code></p>
                        <p>Com base no resultado, ele decide:</p>
                        <ul>
                            <li><strong>Se Backstock >= Qtd. para Abastecer:</strong> O sistema entende que há produto suficiente no depósito. Ele adiciona uma linha na planilha <strong>'REPOSIÇÃO'</strong>, instruindo a equipe a pegar o produto no depósito e repor na prateleira.</li>
                            <li><strong>Se Backstock < Qtd. para Abastecer:</strong> O sistema conclui que não há produto suficiente e é necessário comprar mais. Ele adiciona uma linha na planilha <strong>'COMPRAS'</strong>.</li>
                        </ul>
                    `
                },
                {
                    title: "Passo 3: Interação com as Planilhas Google",
                    content: `
                        <p>Finalmente, o sistema se conecta à API do Google Sheets para atualizar a planilha correspondente (Reposição ou Compras).</p>
                        <p>Ele verifica se já não existe uma solicitação 'ABERTA' para o mesmo produto para evitar duplicidade. Se não houver, ele adiciona uma nova linha com todas as informações necessárias para a equipe, como:</p>
                        <ul>
                            <li>Data da solicitação</li>
                            <li>Nome e código do produto</li>
                            <li>Quantidade a ser reposta/comprada</li>
                            <li>Nome do responsável que fez o registro</li>
                            <li>Status inicial como 'ABERTO'</li>
                        </ul>
                        <p>Após a conclusão, uma mensagem de sucesso é exibida na tela.</p>
                    `
                }
            ];

            function showDemoModal(steps, startIndex = 0) {
                let currentStep = startIndex;

                function updateModalContent() {
                    const step = steps[currentStep];
                    demoModalLabel.innerHTML = `<i class="fas fa-cogs me-2"></i> ${step.title}`;
                    demoModalBody.innerHTML = step.content;

                    let footerHTML = '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>';
                    if (steps.length > 1) {
                        footerHTML = `<button type="button" class="btn btn-outline-secondary" id="prevBtn" ${currentStep === 0 ? 'disabled' : ''}>Anterior</button>` + footerHTML;
                        footerHTML += `<button type="button" class="btn btn-primary" id="nextBtn" ${currentStep === steps.length - 1 ? 'disabled' : ''}>Próximo</button>`;
                    }
                    demoModalFooter.innerHTML = footerHTML;
                }

                updateModalContent();
                demoModal.show();
            }

            // --- Lógica do Scanner de Código de Barras com QuaggaJS ---
            const modalElement = document.getElementById('barcodeScannerModal');
            const barcodeScannerModal = new bootstrap.Modal(modalElement);
            const scanStatusElement = document.getElementById('scanStatus');
            const scannerViewport = document.getElementById('scanner-viewport');
            let quaggaInitialized = false;

            function startScanner() {
                if (window.location.protocol !== 'https:') {
                    alert("O acesso à câmera requer uma conexão segura (HTTPS).");
                    scanStatusElement.textContent = "Erro: HTTPS requerido.";
                    barcodeScannerModal.hide();
                    return;
                }
                if (quaggaInitialized) {
                    Quagga.start();
                    scanStatusElement.textContent = "Aponte para um código de barras...";
                    return;
                }
                scanStatusElement.textContent = "Iniciando câmera...";
                Quagga.init({
                    inputStream: { name: "Live", type: "LiveStream", target: scannerViewport, constraints: { width: { min: 640 }, height: { min: 480 }, facingMode: "environment" } },
                    decoder: { readers: ["ean_reader", "ean_8_reader", "upc_reader", "code_128_reader"] },
                    locate: true
                }, function(err) {
                    if (err) {
                        console.error("Erro ao inicializar QuaggaJS:", err);
                        scanStatusElement.textContent = "Falha ao inicializar o leitor. Verifique as permissões da câmera.";
                        alert("Falha ao inicializar o leitor. Verifique as permissões da câmera.");
                        barcodeScannerModal.hide();
                        return;
                    }
                    quaggaInitialized = true;
                    scanStatusElement.textContent = "Aponte para um código de barras...";
                    Quagga.start();
                });
            }

            Quagga.onDetected(function(result) {
                const code = result.codeResult.code;
                if (code) {
                    scanStatusElement.textContent = `Código detectado: ${code}`;
                    if (navigator.vibrate) { navigator.vibrate(100); }
                    Quagga.pause();
                    handleScannedCode(code);
                }
            });

            function stopScanner() {
                if (quaggaInitialized) Quagga.stop();
            }

            async function handleScannedCode(scannedCode) {
                scanStatusElement.textContent = `Buscando EAN: ${scannedCode}...`;
                try {
                    // Busca o produto usando o EAN. A rota /scan_ean retorna o código e o nome.
                    const eanResponse = await fetch("{{ url_for('scan_ean_route') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ean_code: scannedCode })
                    });
                    const eanData = await eanResponse.json();

                    if (eanData.status === 'success') {
                        // Busca os detalhes completos, incluindo o estoque, usando a outra rota.
                        const productResponse = await fetch(`/get_product_name?codigo=${encodeURIComponent(eanData.codigo_produto)}`);
                        const productData = await productResponse.json();

                        const product = {
                            codigo: eanData.codigo_produto,
                            nome: productData.nome_produto,
                            estoque: productData.estoque_sistema
                        };
                        selectProduct(product);
                        barcodeScannerModal.hide();
                    } else {
                        scanStatusElement.textContent = eanData.message || "Produto não encontrado. Tente novamente.";
                        setTimeout(() => { if (quaggaInitialized) Quagga.start(); }, 2000);
                    }
                } catch (error) {
                    console.error("Erro ao processar código escaneado:", error);
                    scanStatusElement.textContent = "Erro na comunicação com o servidor.";
                    setTimeout(() => { if (quaggaInitialized) Quagga.start(); }, 2000);
                }
            }

            modalElement.addEventListener('shown.bs.modal', startScanner);
            modalElement.addEventListener('hidden.bs.modal', stopScanner);

            // --- INTERCEPTAÇÃO DO SUBMIT PARA DEMONSTRAÇÃO ---
            entradaForm.addEventListener('submit', function(e) {
                e.preventDefault(); // Impede o envio real do formulário

                if (!entradaForm.checkValidity()) {
                    entradaForm.reportValidity();
                    return;
                }

                // Inicia o modal de demonstração
                showDemoModal(demoSteps);

                // Adiciona listeners para os botões de navegação do modal
                document.body.addEventListener('click', function handler(event) {
                    let currentStep = 0; // Precisa ser re-declarado no escopo
                    if (event.target.id === 'nextBtn') {
                        currentStep++;
                        showDemoModal(demoSteps, currentStep);
                    } else if (event.target.id === 'prevBtn') {
                        currentStep--;
                        showDemoModal(demoSteps, currentStep);
                    }
                    // Remove o listener após o uso para evitar múltiplos registros
                    if(event.target.id === 'nextBtn' || event.target.id === 'prevBtn') {
                        document.body.removeEventListener('click', handler);
                    }
                });

                // Reseta o botão de submit para o estado normal
                submitBtn.disabled = true;
                submitBtn.innerHTML = `Registrar Entrada`;
            });

            document.querySelectorAll('.demo-info-icon').forEach(icon => {
                icon.addEventListener('click', function() {
                    const title = this.dataset.title;
                    const explanation = this.dataset.explanation;
                    const singleStep = [{ title: title, content: `<p>${explanation}</p>` }];
                    showDemoModal(singleStep);
                });
            });

        });
    </script>
    <!-- Seus scripts existentes -->
    <!-- Exemplo: <script src="{{ url_for('static', filename='js/main.js') }}"></script> -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register("{{ url_for('static', filename='service-worker.js') }}")
            .then(registration => {
              console.log('ServiceWorker: Registrado com sucesso, escopo: ', registration.scope);
            })
            .catch(error => {
              console.log('ServiceWorker: Falha no registro: ', error);
            });
        });
      }
    </script>
{% endblock %}