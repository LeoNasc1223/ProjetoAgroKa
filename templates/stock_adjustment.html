{% extends "base.html" %}

{% block title %}Ajuste Manual de Estoque{% endblock %}

{% block head %}
{% endblock %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-header bg-dark>
        <h2 class="h4 mb-0">Ajuste Manual de Estoque</h2>
        <p class="mb-0 text-muted">Use esta página para corrigir o estoque de um produto no sistema. Todas as alterações são registradas.</p>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('stock_adjustment') }}" id="adjustment-form">
            <div class="row">
                <div class="col-md-5 mb-3">
                    <label for="codigo_produto" class="form-label">Código do Produto</label>
                    <input type="text" class="form-control" id="codigo_produto" name="codigo_produto" required autofocus>
                </div>
                <div class="col-md-7 mb-3">
                    <label for="nome_produto" class="form-label">Nome do Produto</label>
                    <input type="text" class="form-control" id="nome_produto" name="nome_produto" readonly placeholder="Busque um código para preencher...">
                </div>
            </div>

            <!-- Div para alertas de erro -->
            <div id="error-alert" class="alert alert-danger d-none" role="alert"></div>

            <div id="product-details" class="d-none">
                <hr class="my-4">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="estoque_atual" class="form-label">Estoque Atual</label>
                        <input type="text" class="form-control" id="estoque_atual" readonly>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="novo_estoque" class="form-label">Novo Estoque Total</label>
                        <input type="number" class="form-control" id="novo_estoque" name="novo_estoque" required min="0">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="diferenca" class="form-label">Diferença</label>
                        <input type="text" class="form-control" id="diferenca" readonly>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="motivo" class="form-label">Motivo do Ajuste</label>
                    <textarea class="form-control" id="motivo" name="motivo" rows="3" required placeholder="Ex: Contagem de inventário, quebra, perda, etc."></textarea>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-warning btn-lg"><i class="fas fa-save me-2"></i>Salvar Ajuste</button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const codigoInput = document.getElementById('codigo_produto');
    const nomeProdutoInput = document.getElementById('nome_produto');
    const productDetailsDiv = document.getElementById('product-details');
    const estoqueAtualInput = document.getElementById('estoque_atual');
    const novoEstoqueInput = document.getElementById('novo_estoque');
    const diferencaInput = document.getElementById('diferenca');
    const errorAlert = document.getElementById('error-alert');

    const hideError = () => errorAlert.classList.add('d-none');
    const showError = (message) => {
        errorAlert.textContent = message;
        errorAlert.classList.remove('d-none');
        productDetailsDiv.classList.add('d-none');
    };

    const buscarProduto = async () => {
        hideError();
        const codigo = codigoInput.value.trim();
        if (!codigo) {
            return;
        }

        try {
            const response = await fetch(`/get_product_name?codigo=${encodeURIComponent(codigo)}`);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || `Erro ${response.status}`);
            }

            nomeProdutoInput.value = data.nome_produto;
            estoqueAtualInput.value = data.estoque_sistema;
            novoEstoqueInput.value = data.estoque_sistema;
            productDetailsDiv.classList.remove('d-none');
            calcularDiferenca();

        } catch (error) {
            showError(error.message || 'Ocorreu um erro ao buscar o produto.');
        }
    };

    const calcularDiferenca = () => {
        const estoqueAtual = parseInt(estoqueAtualInput.value, 10);
        const novoEstoque = parseInt(novoEstoqueInput.value, 10);

        if (!isNaN(estoqueAtual) && !isNaN(novoEstoque)) {
            const diff = novoEstoque - estoqueAtual;
            diferencaInput.value = `${diff > 0 ? '+' : ''}${diff}`;
            if (diff > 0) {
                diferencaInput.classList.add('text-success', 'fw-bold');
                diferencaInput.classList.remove('text-danger');
            } else if (diff < 0) {
                diferencaInput.classList.add('text-danger', 'fw-bold');
                diferencaInput.classList.remove('text-success');
            } else {
                diferencaInput.classList.remove('text-success', 'text-danger', 'fw-bold');
            }
        }
    };

    codigoInput.addEventListener('blur', buscarProduto);
    novoEstoqueInput.addEventListener('input', calcularDiferenca);
});
</script>
{% endblock %}